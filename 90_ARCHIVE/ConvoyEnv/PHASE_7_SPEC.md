# Phase 7 Specification: Integration & Gymnasium Registration

**Completed Date:** January 12, 2026
**Final Outcome:** Success. All 7 tests passed. stable-baselines3 installed via tmp build workaround.

**Generated by:** PLANNER Agent
**Date:** January 10, 2026
**For:** BUILDER Agent
**Status:** Ready for Implementation

---

## Status Update

| Phase | Tests | Status |
|-------|-------|--------|
| Phase 0-6 | 70/70 | COMPLETE |
| **Phase 7** | 0/7 | **NOW** |
| Total | 70/80 | 87.5% |

---

## Phase 7 Objective

Integrate all components and make ConvoyEnv available via Gymnasium's standard interface:

1. **Gymnasium Registration** - `gym.make('RoadSense-Convoy-v0')` works
2. **Full Episode Integration Test** - End-to-end with real SUMO
3. **Random Agent Stress Test** - 100 episodes without crashes
4. **SB3 Compatibility** - `check_env()` passes

---

## Prerequisites Verified

| Dependency | Status | Location |
|------------|--------|----------|
| ConvoyEnv (full implementation) | DONE | `convoy_env.py` |
| All sub-components | DONE | `envs/*.py` |
| SUMO scenarios | DONE | `ml/scenarios/base/scenario.sumocfg` |
| ESP-NOW Emulator | DONE | `espnow_emulator/` |

---

## Architecture: Gymnasium Registration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     GYMNASIUM REGISTRATION FLOW                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ml/envs/__init__.py                                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ from gymnasium.envs.registration import register                      │   │
│  │                                                                       │   │
│  │ register(                                                             │   │
│  │     id="RoadSense-Convoy-v0",                                        │   │
│  │     entry_point="envs.convoy_env:ConvoyEnv",                         │   │
│  │     kwargs={"sumo_cfg": "..."},  # Default scenario path             │   │
│  │ )                                                                     │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                │                                             │
│                                ▼                                             │
│  User Code                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ import gymnasium as gym                                               │   │
│  │ import ml.envs  # Triggers registration                              │   │
│  │                                                                       │   │
│  │ env = gym.make("RoadSense-Convoy-v0")                                │   │
│  │ obs, info = env.reset()                                              │   │
│  │ obs, reward, terminated, truncated, info = env.step(0)              │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Implementation Specifications

### 7.1 Gymnasium Registration (`__init__.py`)

```python
# ml/envs/__init__.py

"""
Gymnasium environments for RoadSense V2V.

Registers:
- RoadSense-Convoy-v0: 3-vehicle convoy following with ESP-NOW emulation
"""

import os
from gymnasium.envs.registration import register

# Path to default SUMO scenario
_SCENARIOS_DIR = os.path.join(os.path.dirname(__file__), "..", "scenarios")
_DEFAULT_SCENARIO = os.path.join(_SCENARIOS_DIR, "base", "scenario.sumocfg")

# Register environment
register(
    id="RoadSense-Convoy-v0",
    entry_point="envs.convoy_env:ConvoyEnv",
    kwargs={
        "sumo_cfg": _DEFAULT_SCENARIO,
    },
)

# Export classes for direct import
from envs.convoy_env import ConvoyEnv
from envs.sumo_connection import SUMOConnection, VehicleState
from envs.action_applicator import ActionApplicator
from envs.reward_calculator import RewardCalculator
from envs.observation_builder import ObservationBuilder
from envs.hazard_injector import HazardInjector

__all__ = [
    "ConvoyEnv",
    "SUMOConnection",
    "VehicleState",
    "ActionApplicator",
    "RewardCalculator",
    "ObservationBuilder",
    "HazardInjector",
]
```

---

### 7.2 Integration Test Requirements

**Location:** `ml/tests/integration/test_convoy_env_integration.py`

**Test Environment:**
- Requires SUMO to be installed and accessible via `sumo` command
- Uses real SUMO scenarios from `ml/scenarios/base/`
- Each test should start and stop SUMO cleanly

**Important:** Integration tests are SLOWER than unit tests. Mark them appropriately:
```python
import pytest

@pytest.mark.integration
@pytest.mark.slow
def test_full_episode_completes():
    ...
```

---

## Test Specifications

### Test File: `ml/tests/integration/test_convoy_env_integration.py`

```python
"""
Integration tests for ConvoyEnv with real SUMO.

These tests require:
- SUMO installed and accessible via 'sumo' command
- ml/scenarios/base/scenario.sumocfg exists

Run with: pytest -m integration
"""

import os
import pytest
import numpy as np

# Skip if SUMO not available
SUMO_AVAILABLE = os.system("sumo --version > /dev/null 2>&1") == 0


@pytest.fixture
def scenario_path():
    """Path to base SUMO scenario."""
    base_dir = os.path.dirname(os.path.dirname(os.path.dirname(__file__)))
    return os.path.join(base_dir, "scenarios", "base", "scenario.sumocfg")


@pytest.fixture
def env(scenario_path):
    """ConvoyEnv with real SUMO."""
    from envs.convoy_env import ConvoyEnv

    env = ConvoyEnv(
        sumo_cfg=scenario_path,
        hazard_injection=False,  # Disable for predictable tests
        max_steps=100,  # Short episodes for test speed
    )
    yield env
    env.close()


# === Full Episode Tests (2 tests) ===

@pytest.mark.integration
@pytest.mark.slow
@pytest.mark.skipif(not SUMO_AVAILABLE, reason="SUMO not installed")
def test_full_episode_completes_without_crash(env):
    """
    Run one episode to completion (collision or truncation).

    This test verifies:
    - SUMO starts and connects successfully
    - step() runs without exceptions
    - Episode terminates properly (terminated or truncated)
    """
    obs, info = env.reset()
    assert obs is not None
    assert "step" in info

    done = False
    step_count = 0
    max_steps = 100

    while not done and step_count < max_steps:
        action = env.action_space.sample()  # Random action
        obs, reward, terminated, truncated, info = env.step(action)
        done = terminated or truncated
        step_count += 1

    # Episode should have ended (either collision or truncation)
    assert done or step_count >= max_steps
    assert step_count > 0


@pytest.mark.integration
@pytest.mark.slow
@pytest.mark.skipif(not SUMO_AVAILABLE, reason="SUMO not installed")
def test_full_episode_returns_valid_observations(env):
    """
    Every step returns shape (11,) float32 observation.

    This test verifies observation consistency throughout the episode.
    """
    obs, _ = env.reset()

    # Check initial observation
    assert obs.shape == (11,)
    assert obs.dtype == np.float32

    # Run some steps
    for _ in range(10):
        action = env.action_space.sample()
        obs, reward, terminated, truncated, info = env.step(action)

        # Verify observation at every step
        assert obs.shape == (11,)
        assert obs.dtype == np.float32
        assert np.isfinite(obs).all(), "Observation contains NaN or Inf"

        if terminated or truncated:
            break


# === Gymnasium Registration Tests (3 tests) ===

@pytest.mark.integration
@pytest.mark.skipif(not SUMO_AVAILABLE, reason="SUMO not installed")
def test_gym_make_creates_convoy_env(scenario_path):
    """
    gym.make('RoadSense-Convoy-v0') returns ConvoyEnv instance.
    """
    import gymnasium as gym
    import ml.envs  # Triggers registration

    # Override default scenario path
    env = gym.make(
        "RoadSense-Convoy-v0",
        sumo_cfg=scenario_path,
        max_steps=10,
    )

    try:
        assert env is not None
        from envs.convoy_env import ConvoyEnv
        assert isinstance(env.unwrapped, ConvoyEnv)
    finally:
        env.close()


@pytest.mark.integration
@pytest.mark.skipif(not SUMO_AVAILABLE, reason="SUMO not installed")
def test_registered_env_has_correct_observation_space(scenario_path):
    """
    observation_space is Box(11,) float32.
    """
    import gymnasium as gym
    import ml.envs

    env = gym.make(
        "RoadSense-Convoy-v0",
        sumo_cfg=scenario_path,
        max_steps=10,
    )

    try:
        assert env.observation_space.shape == (11,)
        assert env.observation_space.dtype == np.float32
    finally:
        env.close()


@pytest.mark.integration
@pytest.mark.skipif(not SUMO_AVAILABLE, reason="SUMO not installed")
def test_registered_env_has_correct_action_space(scenario_path):
    """
    action_space is Discrete(4).
    """
    import gymnasium as gym
    import ml.envs

    env = gym.make(
        "RoadSense-Convoy-v0",
        sumo_cfg=scenario_path,
        max_steps=10,
    )

    try:
        from gymnasium.spaces import Discrete
        assert isinstance(env.action_space, Discrete)
        assert env.action_space.n == 4
    finally:
        env.close()


# === Stress Tests (2 tests) ===

@pytest.mark.integration
@pytest.mark.slow
@pytest.mark.skipif(not SUMO_AVAILABLE, reason="SUMO not installed")
def test_random_agent_100_episodes_no_crash(scenario_path):
    """
    Run 100 episodes with random actions.
    All must complete without exception.

    This is a stress test for resource management:
    - SUMO start/stop cycles
    - Emulator queue clearing
    - Memory leaks
    """
    from envs.convoy_env import ConvoyEnv

    env = ConvoyEnv(
        sumo_cfg=scenario_path,
        hazard_injection=True,  # Enable for realistic test
        max_steps=50,  # Short episodes
    )

    try:
        for episode in range(100):
            obs, info = env.reset(seed=episode)  # Different seed each episode
            done = False
            steps = 0

            while not done and steps < 50:
                action = env.action_space.sample()
                obs, reward, terminated, truncated, info = env.step(action)
                done = terminated or truncated
                steps += 1

            # Verify episode ended properly
            assert done or steps >= 50, f"Episode {episode} didn't terminate properly"

    finally:
        env.close()


@pytest.mark.integration
@pytest.mark.slow
@pytest.mark.skipif(not SUMO_AVAILABLE, reason="SUMO not installed")
def test_check_env_passes(scenario_path):
    """
    stable-baselines3 check_env() passes.

    check_env() validates:
    - Observation/action space consistency
    - reset() and step() return correct types
    - No common Gymnasium API violations
    """
    from stable_baselines3.common.env_checker import check_env
    from envs.convoy_env import ConvoyEnv

    env = ConvoyEnv(
        sumo_cfg=scenario_path,
        hazard_injection=False,
        max_steps=10,
    )

    try:
        # check_env raises exception if something is wrong
        check_env(env, warn=True)
    finally:
        env.close()
```

---

## Implementation Steps

| Step | Task | Status |
|------|------|--------|
| 7.1 | Implement Gymnasium registration in `__init__.py` | [ ] |
| 7.2 | Write 2 full episode integration tests | [ ] |
| 7.3 | **VERIFY RED**: Tests fail (env not registered or SUMO issue) | [ ] |
| 7.4 | Fix any integration issues | [ ] |
| 7.5 | **VERIFY GREEN**: Full episode tests pass | [ ] |
| 7.6 | Write 3 Gymnasium registration tests | [ ] |
| 7.7 | **VERIFY RED**: Tests fail (registration not done) | [ ] |
| 7.8 | Verify registration works | [ ] |
| 7.9 | **VERIFY GREEN**: Registration tests pass | [ ] |
| 7.10 | Write random agent stress test (100 episodes) | [ ] |
| 7.11 | Write check_env test | [ ] |
| 7.12 | **VERIFY GREEN**: All stress tests pass | [ ] |
| 7.13 | **PHASE 7 COMPLETE**: 7/7 integration tests passing | [ ] |

---

## Critical Notes for BUILDER

### 1. Test Markers

Integration tests are slow (require SUMO). Use markers:
```python
@pytest.mark.integration
@pytest.mark.slow
@pytest.mark.skipif(not SUMO_AVAILABLE, reason="SUMO not installed")
```

Run integration tests separately:
```bash
pytest -m integration
```

### 2. SUMO Availability Check

Tests should skip gracefully if SUMO isn't installed:
```python
SUMO_AVAILABLE = os.system("sumo --version > /dev/null 2>&1") == 0
```

### 3. Resource Cleanup

Every test must call `env.close()` to prevent orphan SUMO processes:
```python
@pytest.fixture
def env(scenario_path):
    env = ConvoyEnv(...)
    yield env
    env.close()  # CRITICAL
```

### 4. Registration Path Resolution

The `__init__.py` registration must use absolute paths that work from any working directory:
```python
_SCENARIOS_DIR = os.path.join(os.path.dirname(__file__), "..", "scenarios")
```

### 5. SB3 check_env Dependency

The `check_env` test requires `stable-baselines3`:
```bash
pip install stable-baselines3
```

Add to `requirements.txt` if not present.

### 6. Scenario Path Override

Allow tests to override the default scenario:
```python
env = gym.make("RoadSense-Convoy-v0", sumo_cfg=custom_path)
```

---

## Files to Touch

| File | Changes |
|------|---------|
| `ml/envs/__init__.py` | Gymnasium registration (~30 lines) |
| `ml/tests/integration/test_convoy_env_integration.py` | NEW - 7 tests |
| `ml/tests/integration/__init__.py` | NEW - Empty |
| `ml/tests/integration/conftest.py` | NEW - Shared fixtures |
| `requirements.txt` | Add `stable-baselines3` if missing |

---

## Exit Criteria

- [x] All 7 Phase 7 tests pass
- [x] All 70 previous tests still pass (no regressions)
- [x] `gym.make('RoadSense-Convoy-v0')` returns ConvoyEnv
- [x] `env.observation_space` is Box(11,) float32
- [x] `env.action_space` is Discrete(4)
- [x] 100 random episodes complete without crash
- [x] `check_env(env)` passes without warnings
- [x] Total test count: 77/80

---

## Quick Commands

```bash
# Run Phase 7 integration tests only
pytest roadsense-v2v/ml/tests/integration/ -v -m integration

# Run all tests (unit + integration)
pytest roadsense-v2v/ml/tests/ -v

# Skip slow tests (unit only)
pytest roadsense-v2v/ml/tests/ -v -m "not slow"

# Run with coverage
pytest roadsense-v2v/ml/tests/ --cov=ml/envs --cov-report=term-missing
```

---

## Test Configuration (`pytest.ini` or `pyproject.toml`)

Add markers configuration:

```ini
# pytest.ini
[pytest]
markers =
    integration: marks tests as integration tests (require SUMO)
    slow: marks tests as slow (>1s execution time)
```

Or in `pyproject.toml`:

```toml
[tool.pytest.ini_options]
markers = [
    "integration: marks tests as integration tests (require SUMO)",
    "slow: marks tests as slow (>1s execution time)",
]
```

---

## Risks / Notes

### Risk 1: SUMO Process Leaks

**Issue:** If test crashes, SUMO process may remain orphaned.

**Mitigation:** Use `try/finally` in all tests. Consider adding a pytest fixture that kills orphan SUMO processes on teardown.

### Risk 2: TraCI Port Conflicts

**Issue:** Parallel test execution may cause TraCI port conflicts.

**Mitigation:** Use `pytest-xdist` with `--dist=loadscope` or run integration tests sequentially.

### Risk 3: check_env False Positives

**Issue:** `check_env` may pass but policy training fails.

**Mitigation:** Run a short training test in Phase 8 to validate full compatibility.

### Risk 4: CI/CD Environment

**Issue:** SUMO may not be available in CI environments.

**Mitigation:** Integration tests are skipped if SUMO is not installed. Document SUMO installation for CI.

---

**Ready for BUILDER to proceed with Phase 7.**
